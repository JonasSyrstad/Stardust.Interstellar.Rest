<div id="header" class="">
    <div class="dropdown div-inline">
        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
            <i class="glyphicon glyphicon-tags"></i>&nbsp; Sources<span id="label"></span>
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            @foreach (var i in ViewBag.Sources)
            {
                <li><a href="#">@i</a></li>
            }
        </ul>
    </div>
    <div class="btn btn-danger div-inline" id="clearFeed"><i class="glyphicon glyphicon-remove"></i> Clear feed</div>
    <div class="btn btn-info div-inline" id="pause"><i class="glyphicon glyphicon-pause"></i> Pause</div>
    <div class="btn btn-info div-inline" id="start"><i class="glyphicon glyphicon-play-circle"></i> Resume</div>
    <input type="hidden" id="selected" />
    <input type="hidden" id="state" />
    <div class="div-inline">&nbsp;</div>
                                            <div class="inner-addon left-addon div-inline">
                                                <i class="glyphicon glyphicon-filter">&nbsp;&nbsp;</i>
                                                <input  style="display: inline-block; " type="text" class="form-control" id="filterBox" />
                                            </div><div class="btn  div-inline btn-default" id="filter"><i class="glyphicon glyphicon-filter"></i></div>
        <input type="hidden" id="filterString" />
</div>
<div class="info help-block" id="filterhelp"></div>
<hr/>
<div id="container" style="width: 100%; height: 100%;" class="pre-scrollable">
    <div class='itemContainer'>
        <div class="truncate" style="width: 100%">
            <span style="font-weight: bolder">Select a stream....</span>
        </div>
    </div>

</div>

@section scripts
{
    <script src="@Url.Content("~/scripts/jquery.signalR-2.2.1.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/signalr/hubs")"></script>
    <script language="javascript">
        $(function () {
            $("#start").addClass('hidden');
            $("#pause").addClass('hidden');
            var hub = $.connection.updateFeed;
            $("#clearFeed").click(function () {
                $("#container").empty();
                $("#container").append("<div class=\"itemContainer\"></div>");
            });
            $("#pause").click(function () {
                if ($("#state").text() !== "running") {
                    return;
                }
                $("#state").text("stopped");
                $("#pause").addClass('hidden');
                $("#start").removeClass('hidden');
                $.connection.hub.stop();

            });
            $("#filter").click(function () {
                $("#filterString").text($("#filterBox").val());
                if ($("#filterBox").val() !== "")
                    $("#filterhelp").text("Filter: " + $("#filterBox").val());
                else {
                    $("#filterhelp").text("");
                }
            });
            $("#start").click(function () {

                if ($("#state").text() === "running") return;
                $.connection.hub.stop();
                hub.client.cmessage = function (data) {
                    // Container for newItem
                    AppendData(data);
                }
                hub.client.cmessages = function (data) {
                    // Container for newItem'
                    //debugger;
                    $.each(data,
                        function (i, d) {
                            AppendData(d);
                        });
                }
                // Kick off the connection.
                $.connection.hub.start().done(function () {
                    //hub.server.subcribe()
                    hub.server.connect("Connected to log stream", $('#selected').text());
                    $("#state").text("running");
                    $("#start").addClass('hidden');
                    $("#pause").removeClass('hidden');
                });
                $.connection.hub.reconnected(function() {
                    hub.server.connect("Connected to log stream", $('#selected').text());
                });

            });
            //$("#clearFeed").click(function () { });
            $(".dropdown-menu li a").click(function () {

                var selected = $(this).text();


                if (selected === "-Select source-" || selected === $('#selected').text()) return;
                //$(".btn:first-child").text("Sources: " + $(this).text());
                $("#label").text(": " + $(this).text());
                $(".btn:first-child").val($(this).text());
                $('#selected').text(selected);
                // Establish a connection to the updateFeed hub


                hub.client.cmessage = function (data) {
                    // Container for newItem
                    AppendData(data);
                }
                hub.client.cmessages = function (data) {
                    // Container for newItem'
                    //debugger;
                    $.each(data,
                        function (i, d) {
                            AppendData(d);
                        });
                }
                // Kick off the connection.
                $.connection.hub.start().done(function () {
                    //hub.server.subcribe()
                    hub.server.connect("Connected to log stream", selected);
                    $("#state").text("running");
                    $("#start").addClass('hidden');
                    $("#pause").removeClass('hidden');
                });

            });

        });
        function AppendData(data) {

            if ($("#filterString").text() !== null && $("#filterString").text() !== "")
                if ($("#filterString").text() !== data.UserName && $("#filterString").text() !== data.CorrelationToken) return;
            var blankDiv = $("<div class='itemContainer'></div>");
            var errorBox = "alert alert-danger";
            if (data.StackTrace == null) {
                data.StackTrace = "";
                errorBox = "";
            }
            if (data.CorrelationToken == null)
                data.CorrelationToken = "";
            if (data.UserName == null)
                data.UserName = "";
            var prefix = "";
            if ($('#selected').text() === "All" && data.Environment != null)
                prefix = "[" + data.Environment + "] ";
            // Holds the update
            var newItem = $("<div class='alert" +
                data.LogLevel +
                "_item'><span class='truncate'>" +
                prefix +
                data.ServiceName +
                "&gt; [" +
                data.UserName +
                "] (" +
                data.CorrelationToken +
                "): " +
                data.Message +
                "</span></div><div class='" +
                errorBox +
                "'>" +
                data.StackTrace +
                "<div>");

            // Hide our blank div (that will contain the new update), and our new item itself.
            // The blank div will slide down, and our newItem will fade into existence.
            blankDiv.hide();
            newItem.hide();

            // Insert the update at the top of the list, as it's sorted in descending order by publish date.
            $("div#container div:first").before(blankDiv);
            blankDiv.html(newItem);

            // Slide down the blank div (it has a fixed height in CSS), and then fade the new update in.
            blankDiv.slideDown(0,
                null,
                function () {
                    newItem.fadeIn(0);
                    if ($("div#container").children().length > 20000) {
                        try {
                            $("div#container div:last").remove();
                        } catch (e) {
                            console.log(e.message);
                        }
                    }

                }
            );
        }
    </script>
}